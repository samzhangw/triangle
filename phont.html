<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è³½å±€æ¼”è®Šåˆ†æå™¨ Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root { 
            --primary: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --secondary: #ec4899; /* Pink */
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            --text-main: #1e293b;
            --text-light: #64748b;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background: var(--bg-gradient); 
            min-height: 100vh;
            padding: 40px 20px 120px 20px; 
            color: var(--text-main); 
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* --- Header å€å¡Š --- */
        header { 
            text-align: center; margin-bottom: 30px; position: relative;
            background: var(--card-bg); padding: 30px; border-radius: 24px;
            box-shadow: var(--shadow); border: var(--glass-border);
            backdrop-filter: blur(10px);
        }
        h1 { 
            font-size: 2.2rem; margin: 0 0 10px 0; font-weight: 800; letter-spacing: -0.5px;
            background: linear-gradient(to right, var(--primary), var(--secondary)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .desc { color: var(--text-light); font-size: 1rem; }
        
        .btn-help {
            position: absolute; top: 20px; right: 20px;
            background: #f1f5f9; color: var(--text-main); border: none;
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem;
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-help:hover { background: var(--primary); color: white; transform: rotate(15deg); }

        /* --- æ§åˆ¶å„€è¡¨æ¿ (Dashboard) --- */
        .dashboard {
            background: var(--card-bg); padding: 25px; border-radius: 20px;
            box-shadow: var(--shadow); border: var(--glass-border);
            margin-bottom: 30px; display: flex; flex-wrap: wrap; gap: 20px;
            align-items: center; justify-content: space-between;
        }

        .setting-group { display: flex; align-items: center; gap: 15px; flex: 1; min-width: 300px; }
        .setting-label { font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        
        /* ç¾åŒ–æ»‘æ¡¿ */
        input[type=range] {
            flex: 1; height: 6px; border-radius: 5px; background: #e2e8f0; outline: none; -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .slider-value { 
            background: var(--primary); color: white; padding: 2px 10px; border-radius: 10px; 
            font-size: 0.85rem; font-weight: bold; min-width: 35px; text-align: center;
        }

        .action-group { display: flex; gap: 10px; }
        
        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        
        .btn-recalc { background: #f59e0b; color: white; display: none; }
        .btn-excel { background: #10b981; color: white; display: none; }
        .btn-zip { background: #8b5cf6; color: white; display: none; }

        /* --- ä¸Šå‚³å€ --- */
        .upload-area {
            background: rgba(255,255,255,0.6); border: 2px dashed #cbd5e1; border-radius: 20px; 
            padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 30px;
        }
        .upload-area:hover { border-color: var(--primary); background: #eef2ff; transform: scale(1.01); }
        .upload-icon { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; opacity: 0.8; }

        /* --- é€²åº¦æ¢ --- */
        .status-container { margin-bottom: 30px; display: none; }
        .progress-track {
            background: #e2e8f0; border-radius: 10px; height: 10px; overflow: hidden; position: relative;
        }
        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s ease-out;
            position: relative;
        }
        .progress-fill::after { /* æµå…‰å‹•ç•« */
            content: ''; position: absolute; top:0; left:0; bottom:0; right:0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%); animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .status-text { margin-top: 8px; text-align: right; font-size: 0.85rem; color: var(--text-light); font-weight: 500; }

        /* --- çµæœå¡ç‰‡ (Draggable) --- */
        .results-list { display: flex; flex-direction: column; gap: 25px; }
        
        .group-card {
            background: var(--card-bg); border-radius: 20px; padding: 25px;
            box-shadow: var(--shadow); border: var(--glass-border);
            transition: all 0.2s; position: relative;
        }
        .group-card.drag-over { border: 2px solid var(--secondary); background: #fff5f9; transform: scale(1.005); }

        .group-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; 
        }
        .group-title { font-size: 1.25rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px;}
        .group-badge { background: #e0e7ff; color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }

        .game-row { 
            background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 15px; margin-bottom: 15px; 
            position: relative; transition: all 0.2s; cursor: grab; display: flex; flex-direction: column;
        }
        .game-row:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .game-row:active { cursor: grabbing; }
        .game-row.dragging { opacity: 0.4; transform: scale(0.98); border: 2px dashed #94a3b8; }
        .game-row.selected { border: 2px solid var(--secondary); background: #fff0f5; }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .game-id-tag { 
            background: var(--text-main); color: white; padding: 4px 10px; border-radius: 6px; 
            font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px;
        }
        .drag-handle { opacity: 0.5; font-size: 1.1rem; cursor: grab; } /* æ‹–æ›³åœ–ç¤º */
        
        .btn-mini {
            background: white; border: 1px solid #cbd5e1; color: var(--text-light);
            padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: 0.2s;
        }
        .btn-mini:hover { border-color: var(--secondary); color: var(--secondary); }
        .btn-mini.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        /* æ™‚é–“è»¸èˆ‡åœ–ç‰‡ */
        .timeline { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin; }
        .timeline::-webkit-scrollbar { height: 6px; }
        .timeline::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .step { flex: 0 0 auto; text-align: center; width: 100px; }
        .step img {
            width: 100%; height: 100px; object-fit: contain; border: 1px solid #e2e8f0; border-radius: 8px;
            background: white; cursor: zoom-in; transition: transform 0.2s;
        }
        .step img:hover { transform: scale(1.1); border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; position: relative;}
        .step span { font-size: 0.75rem; color: #94a3b8; display: block; margin-top: 4px; }

        /* æ–°å¢ç¾¤çµ„æŒ‰éˆ• */
        .btn-add-group {
            width: 100%; padding: 15px; border: 2px dashed #cbd5e1; border-radius: 16px;
            background: rgba(255,255,255,0.5); color: #64748b; font-weight: 600; cursor: pointer;
            transition: 0.2s; margin-top: 10px; display: none; text-align: center;
        }
        .btn-add-group:hover { border-color: var(--primary); color: var(--primary); background: #eef2ff; }

        /* --- æµ®å‹•æ¯”å°åˆ— --- */
        .compare-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%);
            background: #1e293b; color: white; padding: 12px 25px; border-radius: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 20px;
            z-index: 100; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .compare-bar.show { transform: translateX(-50%) translateY(0); }
        .btn-compare-go { background: var(--secondary); border: none; padding: 6px 18px; border-radius: 20px; color: white; cursor: pointer; font-weight: bold;}
        .btn-close-bar { background: transparent; border: none; color: #94a3b8; font-size: 1.2rem; cursor: pointer; }

        /* --- Modal (é€šç”¨) --- */
        .modal-overlay {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 900px; max-height: 85vh;
            border-radius: 20px; padding: 30px; overflow-y: auto; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ä½¿ç”¨èªªæ˜æ¨£å¼ */
        .help-step { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .help-icon { 
            background: #e0e7ff; color: var(--primary); width: 40px; height: 40px; 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;
        }
        .help-text h4 { margin: 0 0 5px 0; color: var(--text-main); }
        .help-text p { margin: 0; color: var(--text-light); font-size: 0.95rem; }

        /* åœ–ç‰‡æ”¾å¤§ Modal */
        .img-modal-content { background: transparent; box-shadow: none; text-align: center; }
        .img-modal-content img { max-width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
        .img-caption { color: white; margin-top: 15px; font-size: 1.1rem; background: rgba(0,0,0,0.5); display: inline-block; padding: 5px 15px; border-radius: 20px;}

        /* æ¯”å°è¦–çª—æ¨£å¼ */
        .diff-grid { display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 15px; border-bottom: 1px solid #eee; padding: 15px 0; align-items: center; }
        .diff-header { font-weight: bold; color: var(--text-light); text-align: center; background: #f8fafc; padding: 10px; border-radius: 8px; }
        .diff-img-wrap { text-align: center; }
        .diff-img-wrap img { width: 100%; border-radius: 6px; border: 1px solid #eee; }
        .diff-mark { border: 2px solid var(--secondary); box-shadow: 0 0 10px rgba(236, 72, 153, 0.3); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <button class="btn-help" onclick="showHelp()" title="ä½¿ç”¨èªªæ˜">?</button>
        <h1>AI è³½å±€æ¼”è®Šåˆ†æå™¨ <span style="font-size:0.5em; vertical-align:middle; background:var(--text-main); color:white; padding:4px 8px; border-radius:6px;">Pro</span></h1>
        <p class="desc">æ™ºæ…§åˆ†é¡ãƒ»äººæ©Ÿå”ä½œãƒ»ç²¾æº–æ¯”å°</p>
    </header>

    <div id="helpModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ“– ä½¿ç”¨æŒ‡å—</h2>
                <button onclick="closeModal('helpModal')" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="help-step">
                <div class="help-icon">1</div>
                <div class="help-text">
                    <h4>ä¸Šå‚³åœ–ç‰‡</h4>
                    <p>æ‹–æ›³æ‰€æœ‰ <code>Game_XXX_Turn_YYY</code> åœ–ç‰‡åˆ°ä¸Šå‚³å€ã€‚</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-icon">2</div>
                <div class="help-text">
                    <h4>é–‹å§‹åˆ†æ</h4>
                    <p>é»æ“Šã€ŒğŸš€ é–‹å§‹åˆ†æã€ï¼ŒAI æœƒè‡ªå‹•è¨ˆç®—ç‰¹å¾µä¸¦å°‡ç›¸ä¼¼çš„æ£‹å±€åˆ†çµ„ã€‚</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-icon">3</div>
                <div class="help-text">
                    <h4>å¾®èª¿éˆæ•åº¦</h4>
                    <p>è¦ºå¾—åˆ†å¤ªç´°ï¼Ÿå°‡æ»‘æ¡¿å‘å³æ‹‰ï¼ˆè®Šå¯¬é¬†ï¼‰ã€‚è¦ºå¾—æ··åœ¨ä¸€èµ·ï¼Ÿå‘å·¦æ‹‰ï¼ˆè®Šåš´æ ¼ï¼‰ã€‚é»æ“Šã€ŒğŸ”„ é‡ç®—ã€å³å¯ã€‚</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-icon">4</div>
                <div class="help-text">
                    <h4>äººæ©Ÿå”ä½œä¿®æ­£</h4>
                    <p>æŒ‰ä½å¡ç‰‡æ¨™é¡Œæ—çš„ <code>â‹®â‹®</code> æ‹–æ›³ï¼Œå°‡åˆ†éŒ¯çš„å±€ç§»å‹•åˆ°æ­£ç¢ºç¾¤çµ„ï¼Œæˆ–å»ºç«‹æ–°ç¾¤çµ„ã€‚</p>
                </div>
            </div>
            <div class="help-step">
                <div class="help-icon">5</div>
                <div class="help-text">
                    <h4>å·®ç•°æ¯”å°</h4>
                    <p>é»æ“Šå…©å±€çš„ã€Œâš–ï¸ æ¯”å°ã€ï¼Œç³»çµ±æœƒç”¨ç´…æ¡†æ¨™ç¤ºå‡ºå…©å±€ä¹‹é–“åƒç´ ç´šçš„å·®ç•°ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="setting-group">
            <div class="setting-label">
                <span>ğŸ¤– AI åš´æ ¼åº¦</span>
                <span id="thresholdValue" class="slider-value">5</span>
            </div>
            <input type="range" id="thresholdRange" min="0" max="15" value="5" step="1">
        </div>
        
        <div class="action-group">
            <button id="analyzeBtn" class="btn btn-primary" disabled>ğŸš€ é–‹å§‹åˆ†æ</button>
            <button id="recalcBtn" class="btn btn-recalc">ğŸ”„ ä¾è¨­å®šé‡ç®—</button>
            <button id="downloadExcelBtn" class="btn btn-excel">ğŸ“Š ä¸‹è¼‰ Excel</button>
            <button id="downloadZipBtn" class="btn btn-zip">ğŸ’¾ ä¸‹è¼‰ ZIP</button>
        </div>
    </div>

    <div class="upload-area" id="dropZone">
        <span class="upload-icon">ğŸ“‚</span>
        <h3>æ‹–æ›³åœ–ç‰‡æˆ–é»æ“Šé€™è£¡ä¸Šå‚³</h3>
        <p style="color: #94a3b8; margin-top: 5px;">æ”¯æ´å¤šé¸ | æ ¼å¼: Game_X_Turn_Y.png</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    </div>
    
    <div class="status-container" id="statusContainer">
        <div class="progress-track">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="status-text" id="statusText">æº–å‚™å°±ç·’</div>
    </div>

    <div id="resultsList" class="results-list"></div>
    <button id="addGroupBtn" class="btn-add-group">â• æ–°å¢ä¸€å€‹ç©ºç¾¤çµ„ (å°‡è³½å±€æ‹–æ›³è‡³æ­¤)</button>
</div>

<div id="compareBar" class="compare-bar">
    <span id="compareInfo" style="font-size:0.9rem;">å·²é¸æ“‡ 0/2 å±€</span>
    <button id="startCompareBtn" class="btn-compare-go" disabled>é–‹å§‹æ¯”å°</button>
    <button onclick="clearComparison()" class="btn-close-bar" title="å–æ¶ˆ">âœ•</button>
</div>

<div id="compareModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #f1f5f9; padding-bottom:15px;">
            <h2 id="compareTitle" style="margin:0; font-size:1.5rem;">å·®ç•°æ¯”å°</h2>
            <button onclick="closeModal('compareModal')" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div id="compareContent"></div>
    </div>
</div>

<div id="imgModal" class="modal-overlay" onclick="if(event.target===this)closeModal('imgModal')">
    <div class="img-modal-content">
        <img id="modalImg">
        <div id="modalCaption" class="img-caption"></div>
    </div>
</div>

<script>
    // --- UI äº’å‹•é‚è¼¯ ---
    const helpModal = document.getElementById('helpModal');
    function showHelp() { helpModal.style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const recalcBtn = document.getElementById('recalcBtn');
    const downloadExcelBtn = document.getElementById('downloadExcelBtn');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const statusContainer = document.getElementById('statusContainer');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    const resultsList = document.getElementById('resultsList');
    const addGroupBtn = document.getElementById('addGroupBtn');
    
    const thresholdRange = document.getElementById('thresholdRange');
    const thresholdValue = document.getElementById('thresholdValue');
    
    const compareBar = document.getElementById('compareBar');
    const compareInfo = document.getElementById('compareInfo');
    const startCompareBtn = document.getElementById('startCompareBtn');
    const compareModal = document.getElementById('compareModal');
    const compareContent = document.getElementById('compareContent');
    const modalImg = document.getElementById('modalImg');
    const modalCaption = document.getElementById('modalCaption');

    let uploadedFiles = [];
    let clusteredGroups = []; 
    let gameData = {}; 
    let gameSignatures = {};
    let gameIds = [];
    let selectedGames = []; 

    const IMG_SIZE = 150;
    const ANGLES = [0, 60, 120, 180, 240, 300];

    // --- äº‹ä»¶ç›£è½ ---
    thresholdRange.addEventListener('input', (e) => thresholdValue.textContent = e.target.value);
    thresholdRange.addEventListener('change', () => { if(gameIds.length > 0) recalcBtn.style.display = 'inline-flex'; });

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; dropZone.style.background = '#eef2ff'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#cbd5e1'; dropZone.style.background = 'rgba(255,255,255,0.6)'; });
    dropZone.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        dropZone.style.borderColor = '#cbd5e1'; dropZone.style.background = 'rgba(255,255,255,0.6)'; 
        handleFiles(e.dataTransfer.files); 
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    // æ–°å¢ç¾¤çµ„
    addGroupBtn.addEventListener('click', () => {
        clusteredGroups.push({ repId: null, members: [] });
        renderExpandedGroups(clusteredGroups);
        setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
    });

    function handleFiles(files) {
        const imgs = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (!imgs.length) return;
        uploadedFiles = [...uploadedFiles, ...imgs];
        statusContainer.style.display = 'block';
        updateProgress(0, `å·²è¼‰å…¥ ${uploadedFiles.length} å¼µåœ–ç‰‡`);
        analyzeBtn.disabled = false;
        recalcBtn.style.display = 'none';
        downloadExcelBtn.style.display = 'none';
        downloadZipBtn.style.display = 'none';
        addGroupBtn.style.display = 'none';
        resultsList.innerHTML = '';
        gameSignatures = {}; gameIds = [];
        clearComparison();
    }

    function updateProgress(percent, text) {
        progressBar.style.width = `${percent}%`;
        if(text) statusText.textContent = text;
    }

    // --- åˆ†ææµç¨‹ ---
    analyzeBtn.addEventListener('click', async () => await runAnalysis(true));
    recalcBtn.addEventListener('click', async () => await runAnalysis(false));

    async function runAnalysis(fullRun) {
        analyzeBtn.disabled = true;
        recalcBtn.style.display = 'none';
        resultsList.innerHTML = '';
        clearComparison();

        if (fullRun) {
            updateProgress(5, "æ­£åœ¨å»ºç«‹ç´¢å¼•...");
            gameData = {};
            uploadedFiles.forEach(file => {
                const match = file.name.match(/Game_(\d+)_Turn_(\d+)/i);
                if (match) {
                    const gId = match[1];
                    const tId = parseInt(match[2]);
                    if (!gameData[gId]) gameData[gId] = {};
                    gameData[gId][tId] = file;
                }
            });
            gameIds = Object.keys(gameData).sort();
            if (gameIds.length === 0) { alert("ç„¡æœ‰æ•ˆåœ–ç‰‡"); analyzeBtn.disabled = false; return; }

            const totalGames = gameIds.length;
            for (let i = 0; i < totalGames; i++) {
                const gId = gameIds[i];
                updateProgress(5 + Math.round((i / totalGames) * 80), `åˆ†æ Game ${gId}... (${i+1}/${totalGames})`);
                await new Promise(r => setTimeout(r, 0));
                
                const turns = Object.keys(gameData[gId]).map(Number).sort((a,b)=>a-b);
                const signature = [];
                for (let t of turns) {
                    const img = await loadImage(gameData[gId][t]);
                    const hash = await getRotatedHash(img);
                    signature.push({ turn: t, hash: hash });
                }
                gameSignatures[gId] = signature;
            }
        }

        updateProgress(90, "AI ç­–ç•¥æ­¸é¡ä¸­...");
        const currentThreshold = parseInt(thresholdRange.value);
        clusteredGroups = performClustering(gameIds, gameSignatures, currentThreshold);

        updateProgress(95, "æ­£åœ¨ç”¢ç”Ÿè¦–è¦ºåŒ–å ±è¡¨...");
        renderExpandedGroups(clusteredGroups);
        
        updateProgress(100, `åˆ†æå®Œæˆï¼(é–¾å€¼: ${currentThreshold})`);
        analyzeBtn.disabled = false;
        downloadExcelBtn.style.display = 'inline-flex';
        downloadZipBtn.style.display = 'inline-flex';
        addGroupBtn.style.display = 'block';
    }

    // --- æ‹–æ”¾åŠŸèƒ½ (Drag & Drop) ---
    let draggedGameId = null;
    let sourceGroupIndex = null;

    function initDragEvents() {
        const rows = document.querySelectorAll('.game-row');
        const groups = document.querySelectorAll('.group-card');

        rows.forEach(row => {
            row.addEventListener('dragstart', (e) => {
                draggedGameId = row.dataset.gameId;
                sourceGroupIndex = row.closest('.group-card').dataset.index;
                row.classList.add('dragging');
                e.dataTransfer.setData('text/plain', draggedGameId);
                e.dataTransfer.effectAllowed = "move";
            });
            row.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                draggedGameId = null; sourceGroupIndex = null;
                groups.forEach(g => g.classList.remove('drag-over'));
            });
        });

        groups.forEach(group => {
            group.addEventListener('dragover', (e) => {
                e.preventDefault(); group.classList.add('drag-over'); e.dataTransfer.dropEffect = "move";
            });
            group.addEventListener('dragleave', () => group.classList.remove('drag-over'));
            group.addEventListener('drop', (e) => {
                e.preventDefault(); group.classList.remove('drag-over');
                const targetGroupIndex = group.dataset.index;
                if (draggedGameId && sourceGroupIndex !== null && sourceGroupIndex !== targetGroupIndex) {
                    moveGame(draggedGameId, parseInt(sourceGroupIndex), parseInt(targetGroupIndex));
                }
            });
        });
    }

    function moveGame(gameId, fromIdx, toIdx) {
        clusteredGroups[fromIdx].members = clusteredGroups[fromIdx].members.filter(id => id !== gameId);
        clusteredGroups[toIdx].members.push(gameId);
        clusteredGroups[toIdx].members.sort(); 
        renderExpandedGroups(clusteredGroups);
    }

    // --- æ¸²æŸ“ç•«é¢ ---
    function renderExpandedGroups(groups) {
        resultsList.innerHTML = '';
        groups.forEach((group, idx) => {
            const groupCard = document.createElement('div');
            groupCard.className = 'group-card';
            groupCard.dataset.index = idx;
            
            groupCard.innerHTML = `
                <div class="group-header">
                    <div class="group-title">
                        <span>ğŸ§© ç­–ç•¥æ¨¡å¼ ${idx + 1}</span>
                    </div>
                    <span class="group-badge">åŒ…å« ${group.members.length} å±€</span>
                </div>
            `;
            
            if (group.members.length === 0) {
                groupCard.innerHTML += `<div style="text-align:center; color:#94a3b8; padding:30px; border:2px dashed #e2e8f0; border-radius:12px;">( æ­¤ç¾¤çµ„ç‚ºç©ºï¼Œè«‹å°‡åˆ†éŒ¯çš„è³½å±€æ‹–æ›³è‡³æ­¤ )</div>`;
            }

            group.members.forEach(gameId => {
                if(!gameData[gameId]) return;
                const turns = Object.keys(gameData[gameId]).map(Number).sort((a,b)=>a-b);
                let timelineHtml = '<div class="timeline">';
                turns.forEach((turn) => {
                    const imgUrl = URL.createObjectURL(gameData[gameId][turn]);
                    timelineHtml += `
                        <div class="step">
                            <img src="${imgUrl}" onclick="showImgModal('${imgUrl}', 'Game ${gameId} - Turn ${turn}')">
                            <span>T${turn}</span>
                        </div>
                    `;
                });
                timelineHtml += '</div>';
                
                const rowDiv = document.createElement('div');
                rowDiv.className = 'game-row';
                rowDiv.draggable = true;
                rowDiv.dataset.gameId = gameId;
                if(selectedGames.includes(gameId)) rowDiv.classList.add('selected');

                rowDiv.innerHTML = `
                    <div class="game-header">
                        <div class="game-id-tag">
                            <span class="drag-handle" title="æ‹–æ›³ç§»å‹•ç¾¤çµ„">â‹®â‹®</span> Game ${gameId}
                        </div>
                        <button class="btn-mini ${selectedGames.includes(gameId)?'active':''}" onclick="toggleCompare('${gameId}', this)">
                            ${selectedGames.includes(gameId)?'âœ“ å·²é¸':'âš–ï¸ æ¯”å°'}
                        </button>
                    </div>
                    ${timelineHtml}
                `;
                groupCard.appendChild(rowDiv);
            });
            resultsList.appendChild(groupCard);
        });
        initDragEvents();
    }

    // --- æ¯”å°åŠŸèƒ½ ---
    window.toggleCompare = function(gameId, btn) {
        if (selectedGames.includes(gameId)) {
            selectedGames = selectedGames.filter(id => id !== gameId);
        } else {
            if (selectedGames.length >= 2) { alert("ä¸€æ¬¡åªèƒ½æ¯”å°å…©å±€ï¼Œè«‹å…ˆå–æ¶ˆå…¶ä»–é¸æ“‡ã€‚"); return; }
            selectedGames.push(gameId);
        }
        renderExpandedGroups(clusteredGroups); // é‡ç¹ªä»¥æ›´æ–°æ¨£å¼
        updateCompareBar();
    };

    function updateCompareBar() {
        if (selectedGames.length > 0) {
            compareBar.classList.add('show');
            compareInfo.textContent = `å·²é¸æ“‡ ${selectedGames.length}/2 å±€`;
            startCompareBtn.disabled = selectedGames.length !== 2;
        } else { compareBar.classList.remove('show'); }
    }

    window.clearComparison = function() {
        selectedGames = [];
        renderExpandedGroups(clusteredGroups);
        updateCompareBar();
    };

    startCompareBtn.addEventListener('click', async () => {
        if (selectedGames.length !== 2) return;
        const gA = selectedGames[0]; const gB = selectedGames[1];
        compareModal.style.display = 'flex';
        document.getElementById('compareTitle').innerText = `æ¯”å°: Game ${gA} vs ${gB}`;
        compareContent.innerHTML = '<div style="text-align:center; padding:50px; color:#64748b;">æ­£åœ¨åƒç´ ç´šæ¯”å°ä¸­...</div>';
        
        await new Promise(r => setTimeout(r, 100)); // è®“ UI æ¸²æŸ“
        
        const turnsA = Object.keys(gameData[gA]).map(Number);
        const turnsB = Object.keys(gameData[gB]).map(Number);
        const allTurns = Array.from(new Set([...turnsA, ...turnsB])).sort((a,b)=>a-b);

        let html = `
            <div class="diff-grid diff-header">
                <div>å›åˆ</div>
                <div>Game ${gA}</div>
                <div>Game ${gB}</div>
                <div style="color:var(--secondary);">å·®ç•° (Diff)</div>
            </div>
        `;

        for (let t of allTurns) {
            const fA = gameData[gA][t]; const fB = gameData[gB][t];
            let imgA = fA ? `<img src="${URL.createObjectURL(fA)}">` : '<span style="color:#ccc">ç„¡</span>';
            let imgB = fB ? `<img src="${URL.createObjectURL(fB)}">` : '<span style="color:#ccc">ç„¡</span>';
            let diffHtml = '<span style="color:#ccc">-</span>';

            if(fA && fB) {
                try {
                    const blob = await generateDiffImage(await loadImage(fA), await loadImage(fB));
                    diffHtml = `<img src="${URL.createObjectURL(blob)}" class="diff-mark">`;
                } catch(e) {}
            }
            html += `<div class="diff-grid diff-row">
                        <div style="text-align:center; font-weight:bold;">T${t}</div>
                        <div class="diff-img-wrap">${imgA}</div>
                        <div class="diff-img-wrap">${imgB}</div>
                        <div class="diff-img-wrap">${diffHtml}</div>
                     </div>`;
        }
        compareContent.innerHTML = html;
    });

    // --- æ¼”ç®—æ³•èˆ‡å·¥å…·å‡½å¼ ---
    async function generateDiffImage(img1, img2) {
        const w = Math.max(img1.width, img2.width); const h = Math.max(img1.height, img2.height);
        const c = document.createElement('canvas'); c.width = w; c.height = h; const ctx = c.getContext('2d');
        ctx.drawImage(img1, 0, 0, w, h); const d1 = ctx.getImageData(0,0,w,h);
        const c2 = document.createElement('canvas'); c2.width = w; c2.height = h; const ctx2 = c2.getContext('2d');
        ctx2.drawImage(img2, 0, 0, w, h); const d2 = ctx2.getImageData(0,0,w,h);
        const target = ctx.createImageData(w, h);
        for (let i=0; i<d1.data.length; i+=4) {
            const r1=d1.data[i], g1=d1.data[i+1], b1=d1.data[i+2];
            const r2=d2.data[i], g2=d2.data[i+1], b2=d2.data[i+2];
            // å·®ç•°åˆ¤å®š
            if (Math.sqrt((r1-r2)**2+(g1-g2)**2+(b1-b2)**2) > 30) {
                target.data[i]=236; target.data[i+1]=72; target.data[i+2]=153; target.data[i+3]=255; // Pink highlight
            } else {
                const gray = (r1+g1+b1)/3; 
                target.data[i]=gray; target.data[i+1]=gray; target.data[i+2]=gray; target.data[i+3]=50; // Faded
            }
        }
        ctx.putImageData(target, 0, 0);
        return new Promise(resolve => c.toBlob(resolve));
    }

    function performClustering(gameIds, signatures, threshold) {
        const groups = []; const visited = new Set();
        for (let i=0; i<gameIds.length; i++) {
            if(visited.has(gameIds[i])) continue;
            const grp = {repId: gameIds[i], members:[gameIds[i]]}; visited.add(gameIds[i]);
            for(let j=i+1; j<gameIds.length; j++) {
                if(!visited.has(gameIds[j]) && isStrategySimilar(signatures[gameIds[i]], signatures[gameIds[j]], threshold)) {
                    grp.members.push(gameIds[j]); visited.add(gameIds[j]);
                }
            }
            groups.push(grp);
        }
        return groups.sort((a,b)=>b.members.length-a.members.length);
    }
    function isStrategySimilar(sigA, sigB, threshold) {
        const len = Math.min(sigA.length, sigB.length); if(len===0) return false;
        for(let k=0; k<len; k++) {
            if(sigA[k].turn!==sigB[k].turn) continue;
            if(hammingDist(sigA[k].hash, sigB[k].hash) > threshold) return false;
        } return true;
    }
    function showImgModal(src, text) { document.getElementById('imgModal').style.display='flex'; modalImg.src=src; modalCaption.textContent=text; }
    function loadImage(file) { return new Promise(resolve => { const img=new Image(); img.onload=()=>resolve(img); img.src=URL.createObjectURL(file); }); }
    function getRotatedHash(img) { const c = preprocessImage(img); let minH=null; for(let a of ANGLES) { const r=rotateCanvas(c,a); const h=calculateHash(r); if(minH===null||h<minH) minH=h; } return minH; }
    function preprocessImage(img) { const s=IMG_SIZE; const c=document.createElement('canvas'); c.width=s; c.height=s; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,s,s); const sc=Math.min(s/img.naturalWidth, s/img.naturalHeight)*0.9; const w=img.naturalWidth*sc; const h=img.naturalHeight*sc; ctx.drawImage(img, (s-w)/2, (s-h)/2, w, h); return c; }
    function rotateCanvas(s,a) { if(a===0) return s; const c=document.createElement('canvas'); c.width=s.width; c.height=s.height; const x=c.getContext('2d'); x.fillStyle='#fff'; x.fillRect(0,0,c.width,c.height); x.translate(c.width/2, c.height/2); x.rotate(a*Math.PI/180); x.drawImage(s, -c.width/2, -c.height/2); return c; }
    function calculateHash(c) { const s=16; const cv=document.createElement('canvas'); cv.width=s; cv.height=s; const x=cv.getContext('2d'); x.drawImage(c,0,0,s,s); const d=x.getImageData(0,0,s,s).data; let h=""; for(let i=0; i<d.length; i+=4) { const avg=(d[i]+d[i+1]+d[i+2])/3; if(avg>220) h+="0"; else if(d[i]>d[i+1]+30) h+="1"; else if(d[i+2]>d[i]+30) h+="2"; else h+="3"; } return h; }
    function hammingDist(s1, s2) { let d=0; for(let i=0; i<s1.length; i++) if(s1[i]!==s2[i]) d++; return d; }

    downloadExcelBtn.addEventListener('click', () => {
        const data = [];
        clusteredGroups.forEach((g,i) => g.members.forEach(id => data.push({"ç­–ç•¥ç¾¤çµ„":`Pattern ${i+1}`,"è³½å±€ ID":`Game ${id}`,"åŒçµ„æˆå“¡æ•¸":g.members.length,"åˆ¤å®šé–¾å€¼":thresholdRange.value})));
        const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, "åˆ†é¡çµæœ"); XLSX.writeFile(wb, `Game_Analysis_Final.xlsx`);
    });
    downloadZipBtn.addEventListener('click', async () => {
        downloadZipBtn.disabled = true; const zip = new JSZip();
        for(let i=0; i<clusteredGroups.length; i++) {
            const g = clusteredGroups[i]; const pf = zip.folder(`Pattern_${i+1}_(Count_${g.members.length})`);
            g.members.forEach(gid => { if(gameData[gid]) { const gf = pf.folder(`Game_${gid}`); Object.values(gameData[gid]).forEach(f => gf.file(f.name, f)); }});
        }
        try { const c = await zip.generateAsync({type:"blob"}); saveAs(c, `Classified_Games.zip`); } catch(e){} finally { downloadZipBtn.disabled = false; }
    });
</script>
</body>
</html>
